---
- hosts: target
  gather_facts: no

  vars:
    dbname: wordpress
    dbuser: wordpress
    dbpassword: password

  become_user: root
  become: true

  tasks:
    - name: Install Packages
      yum: name={{ item }} state=latest
      with_items:
        - php
        - php-mysql
        - mariadb-server
        - MySQL-python

    - block:
        - name: Install DB (mysql_install_db)
          command: /usr/bin/mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql

        - name: Start DB
          shell: /usr/bin/mysqld_safe --datadir=/var/lib/mysql &

        - name: Wait for DB to come up
          wait_for: host=localhost port=3306 delay=5 timeout=60 state=started

        - name: Set DB root password
          tags: pass
          shell: /usr/bin/mysqladmin -u root password ''
      tags: InitializeDB

    - block:
      - name: Create Database for wordpress
        mysql_db: name={{ dbname }} state=present
      - name: Create user for wordpress
        mysql_user: name={{ dbuser }} password={{ dbpassword }} priv="wordpress.*:ALL" host=localhost state=present

      - name: Get WordPress
        get_url: url=http://ja.wordpress.org/latest-ja.tar.gz dest=/tmp/latest-ja.tar.gz owner=root
      - name: Unarchive a file
        unarchive: src=/tmp/latest-ja.tar.gz dest=/var/www/html copy=no creates=/var/www/html/wordpress
      - name: Copy wp-config.php
        template: src=./wp-config.php.j2 dest=/var/www/html/wordpress/wp-config.php mode=0666
      - name: Change Owner and Group
        file: path=/var/www/html state=directory recurse=yes owner=apache group=apache
      tags: SetupWordpress

    - name: Start and Enable httpd
      shell: /usr/sbin/httpd
